(function(){function t(){return t}function i(t,s){var r=i.resolve(t),n=i.modules[r];if(!n)throw Error('failed to require "'+t+'" from '+s);return n.exports||(n.exports={},n.call(n.exports,n,n.exports,i.relative(r),e)),n.exports}var e=this;i.modules={},i.resolve=function(t){var e=t,s=t+".js",r=t+"/index.js";return i.modules[s]&&s||i.modules[r]&&r||e},i.register=function(t,e){i.modules[t]=e},i.relative=function(e){return function(s){if("debug"==s)return t;if("."!=s.charAt(0))return i(s);var r=e.split("/"),n=s.split("/");r.pop();for(var h=0;n.length>h;h++){var o=n[h];".."==o?r.pop():"."!=o&&r.push(o)}return i(r.join("/"),e)}},i.register("events.js",function(t,i){!function(){function t(){this._events={},this._conf&&e.call(this,this._conf)}function e(t){t&&(this._conf=t,t.delimiter&&(this.delimiter=t.delimiter),t.maxListeners&&(this._events.maxListeners=t.maxListeners),t.wildcard&&(this.wildcard=t.wildcard),t.newListener&&(this.newListener=t.newListener),this.wildcard&&(this.listenerTree={}))}function s(t){this._events={},this.newListener=!1,e.call(this,t)}function r(t,i,e,s){if(!e)return[];var n,h,o,a,l,p,c,u=[],f=i.length,d=i[s],y=i[s+1];if(s===f&&e._listeners){if("function"==typeof e._listeners)return t&&t.push(e._listeners),[e];for(n=0,h=e._listeners.length;h>n;n++)t&&t.push(e._listeners[n]);return[e]}if("*"===d||"**"===d||e[d]){if("*"===d){for(o in e)"_listeners"!==o&&e.hasOwnProperty(o)&&(u=u.concat(r(t,i,e[o],s+1)));return u}if("**"===d){c=s+1===f||s+2===f&&"*"===y,c&&e._listeners&&(u=u.concat(r(t,i,e,f)));for(o in e)"_listeners"!==o&&e.hasOwnProperty(o)&&("*"===o||"**"===o?(e[o]._listeners&&!c&&(u=u.concat(r(t,i,e[o],f))),u=u.concat(r(t,i,e[o],s))):u=o===y?u.concat(r(t,i,e[o],s+2)):u.concat(r(t,i,e[o],s)));return u}u=u.concat(r(t,i,e[d],s+1))}if(a=e["*"],a&&r(t,i,a,s+1),l=e["**"])if(f>s){l._listeners&&r(t,i,l,f);for(o in l)"_listeners"!==o&&l.hasOwnProperty(o)&&(o===y?r(t,i,l[o],s+2):o===d?r(t,i,l[o],s+1):(p={},p[o]=l[o],r(t,i,{"**":p},s+1)))}else l._listeners?r(t,i,l,f):l["*"]&&l["*"]._listeners&&r(t,i,l["*"],f);return u}function n(t,i){t="string"==typeof t?t.split(this.delimiter):t.slice();for(var e=0,s=t.length;s>e+1;e++)if("**"===t[e]&&"**"===t[e+1])return;for(var r=this.listenerTree,n=t.shift();n;){if(r[n]||(r[n]={}),r=r[n],0===t.length){if(r._listeners){if("function"==typeof r._listeners)r._listeners=[r._listeners,i];else if(h(r._listeners)&&(r._listeners.push(i),!r._listeners.warned)){var a=o;this._events.maxListeners!==void 0&&(a=this._events.maxListeners),a>0&&r._listeners.length>a&&(r._listeners.warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",r._listeners.length),console.trace())}}else r._listeners=i;return!0}n=t.shift()}return!0}var h=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)},o=10;s.prototype.delimiter=".",s.prototype.setMaxListeners=function(i){this._events||t.call(this),this._events.maxListeners=i,this._conf||(this._conf={}),this._conf.maxListeners=i},s.prototype.event="",s.prototype.once=function(t,i){return this.many(t,1,i),this},s.prototype.many=function(t,i,e){function s(){0===--i&&r.off(t,s),e.apply(this,arguments)}var r=this;if("function"!=typeof e)throw Error("many only accepts instances of Function");return s._origin=e,this.on(t,s),r},s.prototype.emit=function(){this._events||t.call(this);var i=arguments[0];if("newListener"===i&&!this.newListener&&!this._events.newListener)return!1;if(this._all){for(var e=arguments.length,s=Array(e-1),n=1;e>n;n++)s[n-1]=arguments[n];for(n=0,e=this._all.length;e>n;n++)this.event=i,this._all[n].apply(this,s)}if("error"===i&&!(this._all||this._events.error||this.wildcard&&this.listenerTree.error))throw arguments[1]instanceof Error?arguments[1]:Error("Uncaught, unspecified 'error' event.");var h;if(this.wildcard){h=[];var o="string"==typeof i?i.split(this.delimiter):i.slice();r.call(this,h,o,this.listenerTree,0)}else h=this._events[i];if("function"==typeof h){if(this.event=i,1===arguments.length)h.call(this);else if(arguments.length>1)switch(arguments.length){case 2:h.call(this,arguments[1]);break;case 3:h.call(this,arguments[1],arguments[2]);break;default:for(var e=arguments.length,s=Array(e-1),n=1;e>n;n++)s[n-1]=arguments[n];h.apply(this,s)}return!0}if(h){for(var e=arguments.length,s=Array(e-1),n=1;e>n;n++)s[n-1]=arguments[n];for(var a=h.slice(),n=0,e=a.length;e>n;n++)this.event=i,a[n].apply(this,s);return a.length>0||this._all}return this._all},s.prototype.on=function(i,e){if("function"==typeof i)return this.onAny(i),this;if("function"!=typeof e)throw Error("on only accepts instances of Function");if(this._events||t.call(this),this.emit("newListener",i,e),this.wildcard)return n.call(this,i,e),this;if(this._events[i]){if("function"==typeof this._events[i])this._events[i]=[this._events[i],e];else if(h(this._events[i])&&(this._events[i].push(e),!this._events[i].warned)){var s=o;this._events.maxListeners!==void 0&&(s=this._events.maxListeners),s>0&&this._events[i].length>s&&(this._events[i].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[i].length),console.trace())}}else this._events[i]=e;return this},s.prototype.onAny=function(t){if(this._all||(this._all=[]),"function"!=typeof t)throw Error("onAny only accepts instances of Function");return this._all.push(t),this},s.prototype.addListener=s.prototype.on,s.prototype.off=function(t,i){if("function"!=typeof i)throw Error("removeListener only takes instances of Function");var e,s=[];if(this.wildcard){var n="string"==typeof t?t.split(this.delimiter):t.slice();s=r.call(this,null,n,this.listenerTree,0)}else{if(!this._events[t])return this;e=this._events[t],s.push({_listeners:e})}for(var o=0;s.length>o;o++){var a=s[o];if(e=a._listeners,h(e)){for(var l=-1,p=0,c=e.length;c>p;p++)if(e[p]===i||e[p].listener&&e[p].listener===i||e[p]._origin&&e[p]._origin===i){l=p;break}if(0>l)return this;this.wildcard?a._listeners.splice(l,1):this._events[t].splice(l,1),0===e.length&&(this.wildcard?delete a._listeners:delete this._events[t])}else(e===i||e.listener&&e.listener===i||e._origin&&e._origin===i)&&(this.wildcard?delete a._listeners:delete this._events[t])}return this},s.prototype.offAny=function(t){var i,e=0,s=0;if(t&&this._all&&this._all.length>0){for(i=this._all,e=0,s=i.length;s>e;e++)if(t===i[e])return i.splice(e,1),this}else this._all=[];return this},s.prototype.removeListener=s.prototype.off,s.prototype.removeAllListeners=function(i){if(0===arguments.length)return!this._events||t.call(this),this;if(this.wildcard)for(var e="string"==typeof i?i.split(this.delimiter):i.slice(),s=r.call(this,null,e,this.listenerTree,0),n=0;s.length>n;n++){var h=s[n];h._listeners=null}else{if(!this._events[i])return this;this._events[i]=null}return this},s.prototype.listeners=function(i){if(this.wildcard){var e=[],s="string"==typeof i?i.split(this.delimiter):i.slice();return r.call(this,e,s,this.listenerTree,0),e}return this._events||t.call(this),this._events[i]||(this._events[i]=[]),h(this._events[i])||(this._events[i]=[this._events[i]]),this._events[i]},s.prototype.listenersAny=function(){return this._all?this._all:[]},"function"==typeof define&&define.amd?define(function(){return s}):i.EventEmitter2=s}()}),i.register("isodrive.js",function(t,i,e){function s(t){c.call(this),this.options=t,this.canvas="string"==typeof t.canvas?document.getElementById(t.canvas):t.canvas,this.sprites={},this.spriteMap=t.sprites,this.width=1,this.height=1,this.ctx=this.canvas.getContext("2d"),this.cellWidth=t.cell.width,this.cellHeight=t.cell.height,this.zoneSize=t.zone.size,this.cx=0,this.cy=0,this.zones=[],this.center={x:0,y:0,z:0},this.centerProjection=this.project(this.center),this.player=null,this._changed=!1,this._renderTick=0,this.options.fps&&(this.fps=0),this.init()}function r(t){return Math.round(t)}function n(t,i,e){c.call(this),this.items=[],this.x=t,this.y=i,this.z=e,this.lx=0,this.ly=0,this.lz=0,this.rx=0,this.ry=0,this.rz=0,this._last=0,this._changed=!1,this.map={},this.ui=null}function h(t){c.call(this),this.id=t.id,this._sortId=u++,this.rx=this.x=t.x,this.ry=this.y=t.y,this.rz=this.z=t.z,this.projectionX=0,this.projectionY=0,this.animation=[],this.zone=null,this.ui=null,this._renderTick=null,this.type=t.type||null,this.sprite=t.sprite||null,this.spriteCanvas=null,this.spriteX=0,this.spriteY=0,this.spriteWidth=0,this.spriteHeight=0,this.obstacle=t.obstacle||!1,this.gravitable=t.gravitable||!1,this.falling=!1}function o(t,i,e,s){this.item=t,this.props=i,this.sprite=i.sprite,this.startX=null,this.startY=null,this.startZ=null,this.x=null,this.y=null,this.z=null,this.start=null,this.interval=e||1,this.callback=s}var a=e("util"),l=e("events"),p=e("sprites"),c=l.EventEmitter2;i.inherits=l.inherits,a.inherits(s,c),i.UI=s,i.create=function(t){return new s(t)},s.prototype.init=function(){function t(){var t=window.innerWidth,e=window.innerHeight;"number"==typeof i.options.maxWidth&&(t=Math.min(t,i.options.maxWidth)),"number"==typeof i.options.maxHeight&&(e=Math.min(e,i.options.maxHeight)),i.resize(t,e)}var i=this;this.options.fps&&setInterval(function(){location.hash=i.fps,i.fps=0},1e3),this.ctx.fillStyle="rgba(0,0,0,0.2)",this.ctx.mozspritesmoothingEnabled=!1,this.ctx.webkitspritesmoothingEnabled=!1,this.ctx.msspritesmoothingEnabled=!1,window.addEventListener("resize",t),t();var e=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.RequestAnimationFrame;p.load(this.spriteMap,function(t){i.sprites=t,i.emit("load"),e(function s(){i.render(),e(s)})})},s.prototype.add=function(t){var i=this.getZone(t.x,t.y,t.z);i&&i.add(t)},s.prototype.resize=function(t,i){this._changed=!0,this.width=this.canvas.width=t,this.height=this.canvas.height=i,this.options.center!==!1&&(this.canvas.style.marginLeft=(window.innerWidth-t)/2+"px",this.canvas.style.marginTop=(window.innerHeight-i)/2+"px")},s.prototype.project=function(t,i,e){return{x:Math.round((t-i)*this.cellWidth/2),y:Math.round((1.23*e+(t+i)/2)*this.cellHeight)}},s.prototype.render=function(){if(this._changed){this._changed=!1,this.ctx.clearRect(0,0,this.width,this.height),this.options.fps&&this.fps++;var t=r(this.center.z);this.cx=r(this.width/2-this.centerProjection.x),this.cy=r(this.height/2-this.centerProjection.y);for(var i=this.zones,e=0;i.length>e;e++)i[e].isVisible(t)&&(i[e]._last=0,i[e].sort());this._renderTick=~this._renderTick,this.ctx.save(),this.ctx.translate(this.cx,this.cy);for(var e=5;e>=-5;e--){e>0&&this.ctx.fillRect(-this.cx,-this.cy,this.width,this.height);for(var s=0;i.length>s;s++)i[s].isVisible(t)&&i[s].render(this.ctx,e+t)}for(var s=0;i.length>s;s++)i[s].postRender();this.ctx.restore()}},s.prototype.getItem=function(t){for(var i=0;this.zones.length>i;i++){var e=this.zones[i].getItem(t);if(e)return e}},s.prototype.getZone=function(t,i,e){for(var s=0;this.zones.length>s;s++)if(this.zones[s].containsRaw(t,i,e))return this.zones[s];return!1},s.prototype.addZone=function(t){t.init(this),this.zones.push(t)},s.prototype.setCenter=function(t,i,e,s){if(this.center={x:t,y:i,z:e},this.centerProjection=this.project(t,i,e),0===this.zones.length||s){var r=[[-1,-1,-1],[0,-1,-1],[1,-1,-1],[-1,0,-1],[0,0,-1],[1,0,-1],[-1,1,-1],[0,1,-1],[1,1,-1],[-1,-1,0],[0,-1,0],[1,-1,0],[-1,0,0],[0,0,0],[1,0,0],[-1,1,0],[0,1,0],[1,1,0],[-1,-1,1],[0,-1,1],[1,-1,1],[-1,0,1],[0,0,1],[1,0,1],[-1,1,1],[0,1,1],[1,1,1]];if(t=Math.round(t/this.zoneSize)*this.zoneSize,i=Math.round(i/this.zoneSize)*this.zoneSize,e=Math.round(e/this.zoneSize)*this.zoneSize,0===this.zones.length){for(var h=0;r.length>h;h++){var o=r[h];this.addZone(new n(t+2*o[0]*this.zoneSize,i+2*o[1]*this.zoneSize,e+2*o[2]*this.zoneSize))}for(var h=0;this.zones.length>h;h++){var a=this.zones[h];this.emit("zone:load",{lx:a.lx,ly:a.ly,lz:a.lz,rx:a.rx,ry:a.ry,rz:a.rz})}}else{for(var l=this.player.zone.x,p=this.player.zone.y,c=this.player.zone.z,u=[],f=[],h=0;r.length>h;h++){var a,o=r[h],d=l+o[0]*(this.zoneSize+1),y=p+o[1]*(this.zoneSize+1),v=c+o[2]*(this.zoneSize+1),m=l+2*o[0]*this.zoneSize,g=p+2*o[1]*this.zoneSize,z=c+2*o[2]*this.zoneSize;(a=this.getZone(d,y,v))||(a=new n(m,g,z),f.push(a),this.addZone(a)),u.push(a)}this.zones=u;for(var h=0;f.length>h;h++){var a=f[h];this.emit("zone:load",{lx:a.lx,ly:a.ly,lz:a.lz,rx:a.rx,ry:a.ry,rz:a.rz})}}this.zones.sort(n.compare)}},s.prototype.setPlayer=function(t){this.player=t,this.zones=[],this.setCenter(t.x,t.y,t.z),this.add(t)},s.prototype.handleMove=function(t){var i=!1;if(!t.zone.contains(t)){i=!0,t.remove();for(var e=0;this.zones.length>e;e++)if(this.zones[e].contains(t)){this.zones[e].add(t);break}}this.player===t&&this.setCenter(this.player.x,this.player.y,this.player.z,i)},s.prototype.hasObstacle=function(t,i,e){var s=this.getZone(t,i,e);if(!s)return!0;var r=s.getItemAtPos(t,i,e);return r?r.obstacle?r:!1:!1},a.inherits(n,c),i.Zone=n,n.prototype.init=function(t){this.ui=t,this.lx=this.x-this.ui.zoneSize,this.ly=this.y-this.ui.zoneSize,this.lz=this.z-this.ui.zoneSize,this.rx=this.x+this.ui.zoneSize,this.ry=this.y+this.ui.zoneSize,this.rz=this.z+this.ui.zoneSize},n.prototype.contains=function(t){return this.containsRaw(t.rx,t.ry,t.rz)},n.prototype.containsRaw=function(t,i,e){return t>=this.lx&&this.rx>t&&i>=this.ly&&this.ry>i&&e>=this.lz&&this.rz>e},n.prototype.isVisible=function(t){return t+5>=this.lz&&this.rz>=t-5},n.prototype.getItem=function(t){return this.map.hasOwnProperty(t)&&this.map[t]},n.compare=function(t,i){return t.rz>i.rz?-1:t.rz<i.rz?1:t.rx+t.ry-i.rx-i.ry},n.prototype.sort=function(){if(this._changed){this._changed=!1;for(var t=[],i=0;this.items.length-1>i;i++){var e=this.items[i],s=this.items[i+1];h.compare(e,s)>0&&(t.push(s),this.items.splice(i+1,1),i--)}if(t.length>100)this.items=this.items.concat(t),this.items.sort(h.compare);else for(var i=0;t.length>i;i++)this.insert(t[i])}},n.prototype.render=function(t,i){for(var e=this._last,s=e;this.items.length>s;s++){var r=this.items[s];if(i>r.rz)break;if(i===r.rz){e=s;var n=!1;r!==this.ui.player&&this.ui.player.rz>=i&&(n=r.coverage(this.ui.player),n&&(t.save(),t.globalAlpha=n)),r.render(t),n&&t.restore()}}this._last=e},n.prototype.postRender=function(){for(var t=0;this.items.length>t;t++){var i=this.items[t];i.postRender()}},n.prototype.add=function(t){this.map.hasOwnProperty(t.id)||(t.init(this),this.insert(t),this.map[t.id]=t)},n.prototype.remove=function(t){if(this.map.hasOwnProperty(t.id)){var i=this.items.indexOf(t);-1!==i&&this.items.splice(i,1),delete this.map[t.id]}},n.prototype.insert=function(t){if(0===this.items.length)return this.items.push(t),void 0;for(var i=0,e=this.items.length-1,s=0;e>=i;){s=i+e>>1;var r=h.compare(t,this.items[s]);if(0==r)break;0>r?e=s-1:i=s+1}r>0&&s++,this.items.splice(s,0,t)},n.prototype.getItemAtPos=function(t,i,e){if(0===this.items.length)return!1;for(var s={_sortId:-1,rx:t,ry:i,rz:e},n=0,o=this.items.length-1,a=0;o>=n;){a=n+o>>1;var l=h.compare(s,this.items[a]);if(0==l)break;0>l?o=a-1:n=a+1}l>0&&a++;for(var n=a;this.items.length>n;n++){var p=this.items[n],l=h.compare(s,p);if(l>0)break;if(r(t)===p.rx&&r(i)===p.ry&&r(e)===p.rz)return p}return!1};var u=0;a.inherits(h,c),i.Item=h,h.compare=function(t,i){return t.rz>i.rz?-1:t.rz<i.rz?1:t.rx+t.ry===i.rx+i.ry?t._sortId-i._sortId:h.lineCompare(t,i)},h.lineCompare=function(t,i){return t.rx+t.ry-i.rx-i.ry},h.prototype.init=function(t){this.zone=t,this.ui=t.ui,this.setPosition(this.x,this.y,this.z),this.sprite&&this.setSprite(this.sprite)},h.prototype.setSprite=function(t){this.sprite="string"==typeof t?this.ui.sprites[t]:t,this.spriteCanvas=this.sprite.canvas,this.spriteWidth=this.sprite.width,this.spriteHeight=this.sprite.height,this.spriteX=this.projectionX-this.sprite.x,this.spriteY=this.projectionY-this.sprite.y},h.prototype.coverage=function(t){if(0>=h.lineCompare(this,t))return!1;var i=this.projectionRX-t.projectionRX;return dy=this.projectionRY-t.projectionRY,radius=i*i+dy*dy,radius>9e3?0:(3e3+radius)/18e3},h.prototype.setPosition=function(t,i,e){this.x=t,this.y=i,this.z=e,this.rx=r(t),this.ry=r(i),this.rz=r(e),this.ui.handleMove(this);var s=this.ui.project(t,i,e);this.projectionX=s.x,this.projectionY=s.y;var s=this.ui.project(this.rx,this.ry,this.rz);this.projectionRX=s.x,this.projectionRY=s.y,this.spriteX=this.projectionX-this.sprite.x,this.spriteY=this.projectionY-this.sprite.y,this.ui._changed=!0,this.zone._changed=!0},h.prototype._setPosition=h.prototype.setPosition,h.prototype.move=function(t,i,e){this.setPosition(this.x+t,this.y+i,this.z+e)},h.prototype._move=h.prototype.move,h.prototype.animate=function(t,i,e){this.ui._changed=!0,this.animation.push(new o(this,t,i,e))},h.prototype.reset=function(){if(0!==this.animation.length){for(var t=0;this.animation.length>t;t++){var i=this.animation[t];i.init(),i.end()}this.animation=[]}},h.prototype.render=function(t){this.sprite&&this._renderTick!==this.ui._renderTick&&(this._renderTick=this.ui._renderTick,t.drawImage(this.spriteCanvas,this.spriteX,this.spriteY))},h.prototype.postRender=function(){if(0!==this.animation.length)for(;0!==this.animation.length;){var t=this.animation[0];t.init();{if(!(t.start+t.interval<=Date.now())){t.run(),this.ui._changed=!0;break}this.animation.shift(),t.end(),this.ui._changed=!0}}},h.prototype.command=function(t,i,e){return this.emit("command",t,i),"remove"===t?(this.remove(),e&&e(),!0):!1},h.prototype.remove=function(){this.zone.remove(this)},h.prototype.gravitation=function(t){if(!this.falling){for(var i,e=this.rx,s=this.ry,r=this.rz,n=1;!(i=this.ui.hasObstacle(e,s,r+n));n++);if(i.rz===r+1)return t&&t(),void 0;var h=this;this.falling=!0;var o=i.rz-r-1;this.animate({dz:o},200*o,function(){h.falling=!1,h.gravitation(t)})}},o.prototype.init=function(){if(null===this.start){this.start=Date.now(),this.x=this.startX=this.item.x,this.y=this.startY=this.item.y,this.z=this.startZ=this.item.z;for(var t=["x","y","z"],i=0;t.length>i;i++){var e=t[i];this.props.hasOwnProperty(e)?this[e]=this.props[e]:this.props.hasOwnProperty("d"+e)&&(this[e]+=this.props["d"+e])}this.item.ui.hasObstacle(this.x,this.y,this.z)&&(this.x=this.startX,this.y=this.startY,this.z=this.startZ,this.interval=1)}},o.prototype.run=function(){var t=(Date.now()-this.start)/this.interval,i=this.startX+(this.x-this.startX)*t,e=this.startY+(this.y-this.startY)*t,s=this.startZ+(this.z-this.startZ)*t;this.item.setPosition(i,e,s)},o.prototype.end=function(){this.item.setPosition(this.x,this.y,this.z),this.sprite&&this.item.setSprite(this.sprite),this.callback&&this.callback()}}),i.register("sprites.js",function(t,i){i.load=function(t,i){function e(){h||(h=!0,setTimeout(i.bind(null,r),0))}var s=Object.keys(t),r={},n=s.length;if(0===n)return setTimeout(i,0);s.forEach(function(i){var s=new Image,h=document.createElement("canvas"),o=t[i].match(/^(.*)#(\d+)x(\d+)$/),a=!1;r[i]={width:0,height:0,x:parseInt(o[2],10),y:parseInt(o[3],10),elem:s,canvas:h},s.onload=function(){return a?void 0:(a=!0,r[i].width=s.width,r[i].height=s.height,h.width=s.width,h.height=s.height,h.getContext("2d").drawImage(s,0,0),0===--n?e():void 0)},s.src=o[1]});var h=!1}}),i.register("util.js",function(t,i){function e(t,i){t.super_=i,t.prototype=Object.create(i.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}i.inherits=e});var s=i("isodrive");"undefined"!=typeof module?module.exports=s:Isodrive=s})();